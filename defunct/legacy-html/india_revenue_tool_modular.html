<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Revenue Projection Tool</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="header-container">
            <h1 id="mainTitle">🌏 APAC Revenue Projection Tool</h1>
            <div class="country-selector">
                <label for="countrySelect">Country:</label>
                <select id="countrySelect" onchange="changeCountry(this.value)">
                    <option value="india">🇮🇳 India</option>
                    <option value="singapore">🇸🇬 Singapore</option>
                    <option value="australia">🇦🇺 Australia</option>
                    <option value="japan">🇯🇵 Japan</option>
                    <option value="south_korea">🇰🇷 South Korea</option>
                    <option value="thailand">🇹🇭 Thailand</option>
                    <option value="indonesia">🇮🇩 Indonesia</option>
                    <option value="philippines">🇵🇭 Philippines</option>
                </select>
            </div>
        </div>
        <p class="subtitle">APAC Authentication Services Revenue Modeling with SKU-wise Market Intelligence (2024-25)</p>
        <p style="text-align: center; color: #8b5cf6; font-size: 0.9em; margin-bottom: 20px; font-weight: 500;">
            Version 2.2.0 - Enhanced CRUD Operations & Segment Management (Modular Development Version)
        </p>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab('setup')">📊 Setup & Segments</div>
            <div class="tab" onclick="switchTab('projections')">📈 Projections</div>
            <div class="tab" onclick="switchTab('analysis')">🔍 Analysis</div>
            <div class="tab" onclick="switchTab('demographics')">🌏 Demographics</div>
            <div class="tab" onclick="switchTab('models')">💾 Saved Models</div>
        </div>

        <!-- Setup Tab -->
        <div class="tab-content active" id="setup">
            <div class="input-section">
                <div class="input-group">
                    <label for="startRevenue">Base Monthly Revenue (₹)</label>
                    <input type="number" id="startRevenue" value="0" min="0">
                </div>
                
                <div class="input-group">
                    <label for="projectionMonths">Projection Period (Months)</label>
                    <input type="number" id="projectionMonths" value="12" min="1" max="120">
                </div>

                <div class="input-group">
                    <label for="usdRate">USD Exchange Rate</label>
                    <input type="number" id="usdRate" value="83.50" step="0.01" min="1">
                </div>

                <div class="input-group">
                    <label for="seasonality">Seasonality Pattern</label>
                    <select id="seasonality">
                        <option value="none">No Seasonality</option>
                        <option value="festival">Festival Season (Oct-Dec Peak)</option>
                        <option value="summer">Summer Peak (Jun-Aug)</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="operatingExpenseType">Operating Expenses</label>
                    <select id="operatingExpenseType" onchange="toggleOperatingExpenseInputs()">
                        <option value="fixed">Fixed Monthly Amount</option>
                        <option value="percentage">Percentage of Revenue</option>
                        <option value="hybrid">Both Fixed + Percentage</option>
                    </select>
                </div>

                <div class="input-group" id="fixedExpenseGroup" style="display: block;">
                    <label for="operatingExpenses">Fixed Operating Expenses (₹/month)</label>
                    <input type="number" id="operatingExpenses" value="0" min="0">
                </div>

                <div class="input-group" id="percentageExpenseGroup" style="display: none;">
                    <label for="operatingExpensePercentage">Operating Expense Percentage (%)</label>
                    <input type="number" id="operatingExpensePercentage" value="0" min="0" max="100" step="0.1">
                </div>
            </div>

            <!-- SKU Management Section -->
            <div class="sku-management-section">
                <h2>📦 SKU Management</h2>
                
                <!-- SKU Controls -->
                <div class="sku-controls">
                    <div class="sku-filters">
                        <input type="text" id="segmentSearchFilter" placeholder="🔍 Search segments..." class="search-input">
                        <select id="categoryFilter" class="filter-select">
                            <option value="all">All Categories</option>
                            <option value="authentication">Authentication</option>
                            <option value="biometric">Biometric</option>
                            <option value="kyc">KYC</option>
                            <option value="tokenization">Tokenization</option>
                        </select>
                        <button class="btn-secondary" onclick="clearFilters()">Clear Filters</button>
                    </div>
                    
                    <div class="sku-actions">
                        <button class="btn-primary" onclick="loadPensionModel()">📊 Load Demographic Data</button>
                        <button class="btn-secondary" onclick="addTestSegment()">🧪 Add Test SKU</button>
                        <span class="segment-count">SKUs: <span id="segmentCount">0</span></span>
                    </div>
                </div>

                <!-- Add New SKU Form -->
                <div class="add-sku-form">
                    <h3>➕ Add New SKU</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="segmentName">SKU Name *</label>
                            <input type="text" id="segmentName" placeholder="e.g., OTP Authentication - Banking">
                        </div>
                        
                        <div class="form-group">
                            <label for="segmentCategory">Category</label>
                            <select id="segmentCategory">
                                <option value="authentication">Authentication</option>
                                <option value="biometric">Biometric</option>
                                <option value="kyc">KYC</option>
                                <option value="tokenization">Tokenization</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="pricePerTransaction">Price per Transaction (₹) *</label>
                            <input type="number" id="pricePerTransaction" step="0.01" min="0" placeholder="e.g., 2.50">
                        </div>
                        
                        <div class="form-group">
                            <label for="costPerTransaction">Cost per Transaction (₹) *</label>
                            <input type="number" id="costPerTransaction" step="0.01" min="0" placeholder="e.g., 1.50">
                        </div>
                        
                        <div class="form-group">
                            <label for="monthlyVolume">Monthly Volume *</label>
                            <input type="number" id="monthlyVolume" min="0" placeholder="e.g., 1000000">
                        </div>
                        
                        <div class="form-group">
                            <label for="volumeGrowth">Annual Volume Growth (%)</label>
                            <input type="number" id="volumeGrowth" value="5" step="0.1" placeholder="e.g., 5">
                        </div>
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="segmentNotes">Notes (Optional)</label>
                        <textarea id="segmentNotes" placeholder="Additional notes about this SKU..."></textarea>
                    </div>
                    
                    <div class="form-actions">
                        <button class="btn-primary" onclick="addOrUpdateSegment()">Add SKU</button>
                        <button class="btn-secondary" onclick="clearSegmentForm()">Clear Form</button>
                    </div>
                    
                    <!-- Profitability Check -->
                    <div id="profitabilityCheck" class="profitability-check"></div>
                </div>

                <!-- SKUs List -->
                <div class="segments-list-container">
                    <h3>📋 Current SKUs</h3>
                    <div id="segmentsList" class="segments-list">
                        <!-- SKUs will be dynamically rendered here -->
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="buttons">
                <button class="btn-primary" onclick="calculateProjections()">Calculate Projections</button>
                <button class="btn-warning" onclick="loadPensionModel()">📊 Load Demographic Data</button>
                <button class="btn-warning" onclick="runScenarios()">Run Scenarios</button>
                <button class="btn-success" onclick="showSaveModelDialog()">💾 Save Current Model</button>
                <button class="btn-primary" onclick="loadExternalModelConfig()">📁 Load External Config</button>
                <input type="file" id="modelConfigFile" accept=".json" style="display: none;" onchange="handleModelConfigFile(event)">
            </div>
        </div>
        
        <!-- Projections Tab -->
        <div class="tab-content" id="projections">
            <div class="results-section" id="results" style="display: none;">
                <div class="summary-cards" id="summaryCards"></div>
                <div class="segment-breakdown" id="segmentBreakdown" style="display: none;"></div>
                <div class="chart-container">
                    <div class="chart-controls">
                        <div class="chart-control">
                            <label for="chartMetric">Metric:</label>
                            <select id="chartMetric" onchange="updateChart()">
                                <option value="revenue">Revenue</option>
                                <option value="profit">Net Profit</option>
                                <option value="margin">Profit Margin</option>
                                <option value="volume">Transaction Volume</option>
                            </select>
                        </div>
                        <div class="chart-control">
                            <label for="chartView">View:</label>
                            <select id="chartView" onchange="updateChart()">
                                <option value="total">Total</option>
                                <option value="segments">By Segment</option>
                            </select>
                        </div>
                        <div class="chart-control">
                            <label for="chartPeriod">Period:</label>
                            <select id="chartPeriod" onchange="updateChart()">
                                <option value="1M">1 Month (Daily)</option>
                                <option value="1Y" selected>1 Year</option>
                                <option value="2Y">2 Years</option>
                                <option value="5Y">5 Years</option>
                                <option value="10Y">10 Years</option>
                            </select>
                        </div>
                    </div>
                    <canvas id="revenueChart"></canvas>
                </div>
                <div class="table-controls" id="tableControls" style="display: none; margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <label class="toggle-switch">
                                <input type="checkbox" id="monthlyBreakdown" onchange="toggleMonthlyBreakdown()">
                                <span class="toggle-slider"></span>
                            </label>
                            <span>Show Monthly Breakdown</span>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn-secondary btn-small" onclick="exportTableData('csv')">📄 Export CSV</button>
                            <button class="btn-secondary btn-small" onclick="exportTableData('excel')">📊 Export Excel</button>
                        </div>
                    </div>
                </div>
                <table id="projectionTable"></table>
            </div>
        </div>
        
        <!-- Analysis Tab -->
        <div class="tab-content" id="analysis">
            <!-- Demographic Insights Section -->
            <div class="demographic-insights" id="demographicInsights" style="margin-bottom: 25px;">
                <h2>📊 Demographic Insights</h2>
                <div class="insights-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px;">
                    <div class="insight-card" style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 15px; background: #f9fafb;">
                        <h4 style="margin: 0 0 10px 0; color: #374151;">Current Country Overview</h4>
                        <div id="countryOverview">
                            <div>Total Population: <span id="totalPopulation">-</span>M</div>
                            <div>Available Segments: <span id="totalSegments">-</span></div>
                            <div>Average Auth Rate: <span id="avgAuthRate">-</span>%</div>
                            <div>Average Pension Rate: <span id="avgPensionRate">-</span>%</div>
                        </div>
                    </div>
                    <div class="insight-card" style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 15px; background: #f9fafb;">
                        <h4 style="margin: 0 0 10px 0; color: #374151;">Digital Readiness</h4>
                        <div id="digitalReadiness">
                            <div>Avg Digital Adoption: <span id="avgDigitalAdoption">-</span>%</div>
                            <div>High Digital Segments: <span id="highDigitalSegments">-</span></div>
                            <div>Urbanization Level: <span id="avgUrbanization">-</span>%</div>
                        </div>
                    </div>
                    <div class="insight-card" style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 15px; background: #f9fafb;">
                        <h4 style="margin: 0 0 10px 0; color: #374151;">Economic Profile</h4>
                        <div id="economicProfile">
                            <div>High Economic Tier: <span id="highEconomicSegments">-</span></div>
                            <div>Medium Economic Tier: <span id="mediumEconomicSegments">-</span></div>
                            <div>Low Economic Tier: <span id="lowEconomicSegments">-</span></div>
                        </div>
                    </div>
                    <div class="insight-card" style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 15px; background: #f9fafb;">
                        <h4 style="margin: 0 0 10px 0; color: #374151;">Growth Potential</h4>
                        <div id="growthPotential">
                            <div>Avg Growth Rate: <span id="avgGrowthRate">-</span>%</div>
                            <div>Fast Growing Segments: <span id="fastGrowingSegments">-</span></div>
                            <div>Revenue Potential: <span id="revenueOpportunity">-</span></div>
                        </div>
                    </div>
                </div>
                <div class="demographic-controls">
                    <button class="btn-info" onclick="refreshDemographicInsights()" style="margin-right: 10px;">🔄 Refresh Insights</button>
                    <button class="btn-secondary" onclick="showDemographicDetails()">📈 View Details</button>
                </div>
            </div>
            
            <div class="scenario-section" id="scenarioSection" style="display: none;">
                <h2>Scenario Analysis</h2>
                <div class="scenario-results" id="scenarioResults"></div>
            </div>
            <div class="buttons">
                <button class="btn-success" onclick="exportToExcel()">Export to Excel</button>
            </div>
        </div>
        
        <!-- Demographics Tab -->
        <div class="tab-content" id="demographics">
            <div class="demographics-header">
                <h2>🌏 APAC Demographics Intelligence</h2>
                <p style="color: #666; margin-bottom: 25px;">Explore comprehensive demographic data across all APAC countries with advanced comparison and analysis tools.</p>
                
                <!-- Demographics Navigation -->
                <div class="demo-nav">
                    <button class="demo-nav-btn active" data-section="overview" onclick="showDemographicOverview()">📊 Overview</button>
                    <button class="demo-nav-btn" data-section="explorer" onclick="showCountryExplorer()">🔍 Country Explorer</button>
                    <button class="demo-nav-btn" data-section="comparison" onclick="showCountryComparison()">⚖️ Compare Countries</button>
                    <button class="demo-nav-btn" data-section="analysis" onclick="showSegmentAnalysis()">📈 Segment Analysis</button>
                </div>
            </div>

            <!-- Overview Section -->
            <div id="demographicOverviewSection" style="display: block;">
                <div class="overview-cards">
                    <div class="overview-card">
                        <h3>Total Countries</h3>
                        <div class="overview-value" id="totalCountriesOverview">-</div>
                    </div>
                    <div class="overview-card">
                        <h3>Total Segments</h3>
                        <div class="overview-value" id="totalSegmentsOverview">-</div>
                    </div>
                    <div class="overview-card">
                        <h3>Total Population</h3>
                        <div class="overview-value" id="totalPopulationOverview">-</div>
                    </div>
                    <div class="overview-card">
                        <h3>Avg Auth Rate</h3>
                        <div class="overview-value" id="avgAuthRateOverview">-</div>
                    </div>
                    <div class="overview-card">
                        <h3>Avg Pension Rate</h3>
                        <div class="overview-value" id="avgPensionRateOverview">-</div>
                    </div>
                </div>

                <div class="countries-table-container">
                    <h3>APAC Countries Overview</h3>
                    <table id="countriesOverviewTable" class="demographics-table">
                        <!-- Table will be populated by JavaScript -->
                    </table>
                </div>
            </div>

            <!-- Country Explorer Section -->
            <div id="countryExplorerSection" style="display: none;">
                <div class="country-explorer">
                    <div class="explorer-header">
                        <div class="country-selector-demo">
                            <label for="explorerCountrySelect">Select Country:</label>
                            <select id="explorerCountrySelect" onchange="loadCountryDetails(this.value)">
                                <option value="india">🇮🇳 India</option>
                                <option value="singapore">🇸🇬 Singapore</option>
                                <option value="australia">🇦🇺 Australia</option>
                            </select>
                        </div>
                    </div>

                    <div class="country-details">
                        <div class="country-header">
                            <h3 id="explorerCountryName">Select a country</h3>
                            <div class="country-stats">
                                <span>Population: <span id="explorerCountryPopulation">-</span>M</span>
                                <span>Currency: <span id="explorerCountryCurrency">-</span></span>
                            </div>
                        </div>

                        <div class="country-summary">
                            <div class="summary-metric">
                                <span>Segments:</span>
                                <span id="explorerTotalSegments">-</span>
                            </div>
                            <div class="summary-metric">
                                <span>Avg Auth Rate:</span>
                                <span id="explorerAvgAuthRate">-</span>
                            </div>
                            <div class="summary-metric">
                                <span>Avg Pension Rate:</span>
                                <span id="explorerAvgPensionRate">-</span>
                            </div>
                            <div class="summary-metric">
                                <span>Avg Digital Adoption:</span>
                                <span id="explorerAvgDigitalAdoption">-</span>
                            </div>
                        </div>

                        <div class="segments-table-container">
                            <table id="explorerSegmentsTable" class="demographics-table">
                                <!-- Table will be populated by JavaScript -->
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Country Comparison Section -->
            <div id="countryComparisonSection" style="display: none;">
                <div class="country-comparison">
                    <div class="comparison-controls">
                        <div class="comparison-selectors">
                            <div class="selector-group">
                                <label for="compareCountry1">Country 1:</label>
                                <select id="compareCountry1">
                                    <option value="india">🇮🇳 India</option>
                                    <option value="singapore">🇸🇬 Singapore</option>
                                    <option value="australia">🇦🇺 Australia</option>
                                </select>
                            </div>
                            <div class="vs-indicator">VS</div>
                            <div class="selector-group">
                                <label for="compareCountry2">Country 2:</label>
                                <select id="compareCountry2">
                                    <option value="singapore">🇸🇬 Singapore</option>
                                    <option value="india">🇮🇳 India</option>
                                    <option value="australia">🇦🇺 Australia</option>
                                </select>
                            </div>
                        </div>
                        <button class="btn-primary" onclick="compareCountries()">📊 Compare</button>
                    </div>

                    <div id="comparisonResults" class="comparison-results">
                        <!-- Comparison results will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Segment Analysis Section -->
            <div id="segmentAnalysisSection" style="display: none;">
                <div class="segment-analysis">
                    <h3>📈 Demographic Segment Analysis</h3>
                    <p>Advanced segment analysis features coming soon...</p>
                </div>
            </div>
        </div>

        <!-- Models Tab -->
        <div class="tab-content" id="models">
            <div class="models-section">
                <h2>💾 Saved Models</h2>
                <div class="models-controls">
                    <button class="btn-success" onclick="showSaveModelDialog()">💾 Save Current Model</button>
                    <button class="btn-primary" onclick="exportAllModels()">📤 Export All</button>
                    <button class="btn-secondary" onclick="importModels()">📥 Import Models</button>
                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="handleImportFile(event)">
                </div>
                
                <div class="models-grid" id="modelsGrid">
                    <!-- Models will be dynamically rendered here -->
                </div>
            </div>
        </div>
    </div>

    <!-- SKU Edit Dialog -->
    <div id="skuEditDialog" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="skuEditTitle">✏️ Edit SKU</h2>
                <button class="modal-close" onclick="closeSkuEditDialog()">&times;</button>
            </div>
            <form id="skuEditForm" class="modal-body">
                <div id="skuEditValidation" class="validation-messages" style="display: none;"></div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="editSkuName">SKU Name *</label>
                        <input type="text" id="editSkuName" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="editSkuCategory">Category</label>
                        <select id="editSkuCategory">
                            <option value="authentication">Authentication</option>
                            <option value="biometric">Biometric</option>
                            <option value="kyc">KYC</option>
                            <option value="tokenization">Tokenization</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="editSkuPrice">Price per Transaction (₹) *</label>
                        <input type="number" id="editSkuPrice" step="0.01" min="0" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="editSkuCost">Cost per Transaction (₹) *</label>
                        <input type="number" id="editSkuCost" step="0.01" min="0" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="editSkuVolume">Monthly Volume *</label>
                        <input type="number" id="editSkuVolume" min="0" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="editSkuGrowth">Annual Volume Growth (%)</label>
                        <input type="number" id="editSkuGrowth" step="0.1">
                    </div>
                </div>
                
                <div class="form-group full-width">
                    <label for="editSkuNotes">Notes</label>
                    <textarea id="editSkuNotes"></textarea>
                </div>
            </form>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeSkuEditDialog()">Cancel</button>
                <button type="button" class="btn-primary" onclick="updateSku()">Update SKU</button>
                <button type="button" class="btn-warning" onclick="duplicateCurrentSku()">📋 Duplicate</button>
                <button type="button" class="btn-danger" onclick="deleteCurrentSku()">🗑️ Delete</button>
            </div>
        </div>
    </div>

    <!-- Load all modular JavaScript files -->
    <script src="js/core.js"></script>
    <script src="js/segments.js"></script>
    <script src="js/projections.js"></script>
    <script src="js/demographics.js"></script>
    <script src="js/export.js"></script>
    <script src="js/ui.js"></script>
    
    <!-- Initialize the application -->
    <script>
        // Initialize the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initializeSegmentTypes();
            updatePredefinedSegments();
            
            // Auto-refresh demographic insights
            if (typeof refreshDemographicInsights === 'function') {
                setTimeout(refreshDemographicInsights, 1000);
            }
            
            // Initialize demographic data if not already loaded
            if (!window.externalDemographicData && !window.regionalData) {
                if (typeof initializeDemographicData === 'function') {
                    initializeDemographicData();
                }
            }
        });
        
        // Additional initialization functions that need to be preserved
        function changeCountry(country) {
            window.currentCountry = country;
            
            // Update title
            const countryNames = {
                'india': '🇮🇳 India',
                'singapore': '🇸🇬 Singapore', 
                'australia': '🇦🇺 Australia',
                'japan': '🇯🇵 Japan',
                'south_korea': '🇰🇷 South Korea',
                'thailand': '🇹🇭 Thailand',
                'indonesia': '🇮🇩 Indonesia',
                'philippines': '🇵🇭 Philippines'
            };
            
            const mainTitle = document.getElementById('mainTitle');
            if (mainTitle) {
                mainTitle.textContent = `🌏 APAC Revenue Projection Tool - ${countryNames[country] || country}`;
            }
            
            // Trigger demographic insights update
            if (typeof updateDemographicInsightsOnCountryChange === 'function') {
                updateDemographicInsightsOnCountryChange();
            }
        }
        
        // Model management functions (preserved from original)
        function showSaveModelDialog() {
            // Implementation needed - create modal for saving models
            const modelName = prompt('Enter a name for this model:');
            if (modelName && modelName.trim()) {
                saveCurrentModel(modelName.trim());
            }
        }
        
        function saveCurrentModel(name) {
            // Implementation needed - save current segments and settings as a model
            console.log('Saving model:', name);
        }
        
        function loadExternalModelConfig() {
            document.getElementById('modelConfigFile').click();
        }
        
        function handleModelConfigFile(event) {
            // Implementation needed - handle external model config loading
            console.log('Loading model config file:', event.target.files[0]);
        }
    </script>
</body>
</html>